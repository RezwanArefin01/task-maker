package(default_visibility = ["//visibility:public"])

PYTHON_HDRS = [
    "python_3_6_files/include/python3.6m/errcode.h",
    "python_3_6_files/include/python3.6m/intrcheck.h",
    "python_3_6_files/include/python3.6m/pymacro.h",
    "python_3_6_files/include/python3.6m/pyatomic.h",
    "python_3_6_files/include/python3.6m/pystrhex.h",
    "python_3_6_files/include/python3.6m/Python-ast.h",
    "python_3_6_files/include/python3.6m/abstract.h",
    "python_3_6_files/include/python3.6m/structseq.h",
    "python_3_6_files/include/python3.6m/datetime.h",
    "python_3_6_files/include/python3.6m/pymath.h",
    "python_3_6_files/include/python3.6m/graminit.h",
    "python_3_6_files/include/python3.6m/parsetok.h",
    "python_3_6_files/include/python3.6m/pymem.h",
    "python_3_6_files/include/python3.6m/structmember.h",
    "python_3_6_files/include/python3.6m/funcobject.h",
    "python_3_6_files/include/python3.6m/dtoa.h",
    "python_3_6_files/include/python3.6m/dynamic_annotations.h",
    "python_3_6_files/include/python3.6m/pyconfig.h",
    "python_3_6_files/include/python3.6m/accu.h",
    "python_3_6_files/include/python3.6m/pystate.h",
    "python_3_6_files/include/python3.6m/pyctype.h",
    "python_3_6_files/include/python3.6m/bitset.h",
    "python_3_6_files/include/python3.6m/pystrtod.h",
    "python_3_6_files/include/python3.6m/object.h",
    "python_3_6_files/include/python3.6m/typeslots.h",
    "python_3_6_files/include/python3.6m/osmodule.h",
    "python_3_6_files/include/python3.6m/unicodeobject.h",
    "python_3_6_files/include/python3.6m/odictobject.h",
    "python_3_6_files/include/python3.6m/bytesobject.h",
    "python_3_6_files/include/python3.6m/fileobject.h",
    "python_3_6_files/include/python3.6m/fileutils.h",
    "python_3_6_files/include/python3.6m/bytearrayobject.h",
    "python_3_6_files/include/python3.6m/complexobject.h",
    "python_3_6_files/include/python3.6m/genobject.h",
    "python_3_6_files/include/python3.6m/metagrammar.h",
    "python_3_6_files/include/python3.6m/pydebug.h",
    "python_3_6_files/include/python3.6m/py_curses.h",
    "python_3_6_files/include/python3.6m/listobject.h",
    "python_3_6_files/include/python3.6m/frameobject.h",
    "python_3_6_files/include/python3.6m/marshal.h",
    "python_3_6_files/include/python3.6m/pyport.h",
    "python_3_6_files/include/python3.6m/opcode.h",
    "python_3_6_files/include/python3.6m/moduleobject.h",
    "python_3_6_files/include/python3.6m/pymacconfig.h",
    "python_3_6_files/include/python3.6m/floatobject.h",
    "python_3_6_files/include/python3.6m/asdl.h",
    "python_3_6_files/include/python3.6m/pyexpat.h",
    "python_3_6_files/include/python3.6m/methodobject.h",
    "python_3_6_files/include/python3.6m/longintrepr.h",
    "python_3_6_files/include/python3.6m/pyhash.h",
    "python_3_6_files/include/python3.6m/grammar.h",
    "python_3_6_files/include/python3.6m/memoryobject.h",
    "python_3_6_files/include/python3.6m/tupleobject.h",
    "python_3_6_files/include/python3.6m/iterobject.h",
    "python_3_6_files/include/python3.6m/warnings.h",
    "python_3_6_files/include/python3.6m/classobject.h",
    "python_3_6_files/include/python3.6m/pyfpe.h",
    "python_3_6_files/include/python3.6m/enumobject.h",
    "python_3_6_files/include/python3.6m/descrobject.h",
    "python_3_6_files/include/python3.6m/pystrcmp.h",
    "python_3_6_files/include/python3.6m/eval.h",
    "python_3_6_files/include/python3.6m/objimpl.h",
    "python_3_6_files/include/python3.6m/ceval.h",
    "python_3_6_files/include/python3.6m/pythonrun.h",
    "python_3_6_files/include/python3.6m/rangeobject.h",
    "python_3_6_files/include/python3.6m/pydtrace.h",
    "python_3_6_files/include/python3.6m/sliceobject.h",
    "python_3_6_files/include/python3.6m/traceback.h",
    "python_3_6_files/include/python3.6m/ast.h",
    "python_3_6_files/include/python3.6m/cellobject.h",
    "python_3_6_files/include/python3.6m/osdefs.h",
    "python_3_6_files/include/python3.6m/modsupport.h",
    "python_3_6_files/include/python3.6m/setobject.h",
    "python_3_6_files/include/python3.6m/code.h",
    "python_3_6_files/include/python3.6m/weakrefobject.h",
    "python_3_6_files/include/python3.6m/node.h",
    "python_3_6_files/include/python3.6m/sysmodule.h",
    "python_3_6_files/include/python3.6m/longobject.h",
    "python_3_6_files/include/python3.6m/pgenheaders.h",
    "python_3_6_files/include/python3.6m/compile.h",
    "python_3_6_files/include/python3.6m/import.h",
    "python_3_6_files/include/python3.6m/codecs.h",
    "python_3_6_files/include/python3.6m/Python.h",
    "python_3_6_files/include/python3.6m/token.h",
    "python_3_6_files/include/python3.6m/pylifecycle.h",
    "python_3_6_files/include/python3.6m/bltinmodule.h",
    "python_3_6_files/include/python3.6m/dictobject.h",
    "python_3_6_files/include/python3.6m/namespaceobject.h",
    "python_3_6_files/include/python3.6m/pgen.h",
    "python_3_6_files/include/python3.6m/bytes_methods.h",
    "python_3_6_files/include/python3.6m/boolobject.h",
    "python_3_6_files/include/python3.6m/pytime.h",
    "python_3_6_files/include/python3.6m/patchlevel.h",
    "python_3_6_files/include/python3.6m/ucnhash.h",
    "python_3_6_files/include/python3.6m/pyarena.h",
    "python_3_6_files/include/python3.6m/pythread.h",
    "python_3_6_files/include/python3.6m/pycapsule.h",
    "python_3_6_files/include/python3.6m/pyerrors.h",
    "python_3_6_files/include/python3.6m/pygetopt.h",
    "python_3_6_files/include/python3.6m/symtable.h",
]

PYTHON_RUNTIME = [
    "python_3_6_files/bin/python",
    "python_3_6_files/bin/python3",
    "python_3_6_files/bin/python3.6",
    "python_3_6_files/lib/python3.6",
    "python_3_6_files/lib/libpython3.6m.so.1.0",
    "python_3_6_files/lib/libpython3.6m.so",
    "python_3_6_files/lib/libpython3.6m.dylib",
]

# TODO(veluca): add --enable-optimizations?
# The calls to touch at the end are to ensure that all files are present
# as output of the rule, even if we will use only some of them.
PYTHON_COMPILE_COMMAND = " \
  export CFLAGS='-Wno-implicit-fallthrough -Wno-stringop-overflow' && \
  export DIR=`pwd` && cd `dirname $(location Python-3.6.3/configure)` && \
  ./configure --prefix=$$DIR/$(@D)/python_3_6_files \
              --enable-shared --with-lto \
              --exec-prefix=$$DIR/$(@D)/python_3_6_files > /dev/null && \
  make install > /dev/null && make distclean > /dev/null && \
  ln -s python3 $$DIR/$(@D)/python_3_6_files/bin/python && \
  touch $$DIR/$(@D)/python_3_6_files/lib/libpython3.6m.so.1.0 && \
  touch $$DIR/$(@D)/python_3_6_files/lib/libpython3.6m.so && \
  touch $$DIR/$(@D)/python_3_6_files/lib/libpython3.6m.dylib"

config_setting(
    name = "darwin",
    values = {"cpu": "darwin"},
    visibility = ["//visibility:public"],
)

config_setting(
    name = "darwin_x86_64",
    values = {"cpu": "darwin_x86_64"},
    visibility = ["//visibility:public"],
)

filegroup(
    name = "python_3_6_interpreter",
    srcs = PYTHON_RUNTIME,
)

genrule(
    name = "python_3_6_runtime",
    srcs = glob(
        include = ["Python-3.6.3/**"],
    ),
    outs = PYTHON_HDRS + PYTHON_RUNTIME,
    cmd = PYTHON_COMPILE_COMMAND,
)

cc_library(
    name = "python_3_6_hdr",
    srcs = select({
        ":darwin": [":python_3_6_files/lib/libpython3.6m.dylib"],
        ":darwin_x86_64": [":python_3_6_files/lib/libpython3.6m.dylib"],
        "//conditions:default": [":python_3_6_files/lib/libpython3.6m.so"],
    }),
    hdrs = PYTHON_HDRS,
    strip_include_prefix = "python_3_6_files/include/python3.6m/",
)
